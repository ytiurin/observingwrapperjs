<!DOCTYPE html>
<html><head><script src="observing-wrapper.js"></script><script>

function outputResult(condition, trueMessage, falseMessage)
{
  document.open();
  condition ? document.write('<p style="color:green">'+trueMessage+'</p>') : 
    document.write('<p style="color:red">'+falseMessage+'</p>');
  document.close();
}

!function testObservation() {try{
  var obsnObject = new observingWrapper.__constructor({p:'foo', f: new Function});
  var ole = obsnObject.observableKeys;
  var i=0;

  obsnObject.addChangeHandler(function(changes) {
    var ch=changes[0];
    ch.name==='p'&&ch.object[ch.name]==='foo0'&&i++;
    ch.name==='f'&&ch.type==='call'&&ch.arguments[0]==='foo1'&&ch.arguments[1] 
      ==='foo2'&&i++;
    ch.name==='f'&&ch.type==='update'&&ch.object[ch.name]==='foo3'&&i++; 
  });

  ole.p='foo0';
  ole.f('foo1', 'foo2');
  ole.f='foo3';

  outputResult(i === 3, 'Observation works', 'Observation failed');

}catch(e){
  outputResult(false, '', 'Observation crashed');
}}()

!function testPrototyping() {
  function ff() {this.p1='foo1'};
  ff.prototype = {p0:'foo0'};

  var objectWithPrototype = new ff;
  var obsnObject = new observingWrapper.__constructor(objectWithPrototype);

  outputResult(obsnObject.observableKeys.p0, 'Prototyping works', 'Prototyping failed');
}()

!function testArray() {
  var obsnObject = new observingWrapper.__constructor([]);
  var ole = obsnObject.observableKeys;
  var i = 0;
  obsnObject.addChangeHandler(function(changes){
    if(['push','splice'].indexOf(changes[0].name)>-1)
      i++;
  });

  ole.push(1);
  ole.push(2);
  ole.splice(0,1);

  outputResult(i === 3 && ole.length===1 && ole[0]===2, 'Arrays work', 'Arrays failed');
}()

!function testObservingWrapper() {
  var i=0;
  var obsnObject=observingWrapper({p:'foo',f:new Function},function(changes){
    var ch=changes[0]
    ch.name==='p'&&ch.object[ch.name]==='foo0'&&i++;
    ch.name==='f'&&ch.type==='call'&&ch.arguments[0]==='foo1'&&ch.arguments[1] 
      ==='foo2'&&i++;
  });

  obsnObject.p = 'foo0';
  obsnObject.f('foo1', 'foo2');
  
  outputResult(i === 2, 'Observing wrapper works', 'Observing wrapper failed');
}()

!function testRemoving() {
  var i = 0;
  var obsnObject = new observingWrapper.__constructor({p:''});

  !function() {
    function f1(k,v) {i++;};
    obsnObject.addChangeHandler(f1);
  }()
  !function() {
    function f1(k,v) {i++;};
    obsnObject.removeChangeHandler(f1);
    obsnObject.addChangeHandler(f1);
    obsnObject.observableKeys.p = 'foo1';
    obsnObject.removeChangeHandler(f1);
    obsnObject.observableKeys.p = 'foo2';
  }()
  
  outputResult(i===5, 'Removing works', 'Removing failed');
}()

!function testFiltering() {
  var obsnObject = new observingWrapper.__constructor({p1:1, p2:2});
  var ole = obsnObject.observableKeys;
  var i=0;
  
  function f(changes) {
    i++;
  }

  obsnObject.addChangeHandler('p1',f);
  obsnObject.addChangeHandler('p1',f);

  ole.p1=3;
  ole.p2=4;

  obsnObject.removeChangeHandler('p1',f);
  ole.p1=5;

  outputResult(i === 2, 'Filtering works', 'Filtering failed');
}()

document.close(); 

</script></head><body></body></html>
