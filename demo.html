<!DOCTYPE html>
<html><head><script src="observing-wrapper.js"></script><script>

function c(){console.log.apply(console,arguments)}

var
viewModel=observingWrapper({
  colors: ['red','green','blue'],
  site: 'best.com',
  shape: [{name:'Triangle',look:'Edgy'},{name:'Circle',look:'Round'},{name:'Square',look:'Blocky'}],
  lang: [{code:'en',name:'English'},{code:'fr',name:'French'},{code:'nl',name:'Dutch'}]
});

function nodeInsertAfter(referenceNode, newNode) {
  referenceNode.parentNode.insertBefore(newNode,referenceNode.nextSibling);
}
function nodeRemove(node) {
  node.parentNode.removeChild(node);
}

// function bindNodeToArrayModel(nodeParams,modelName,i)
// {
//   console.log('bindNodeToArrayModel',{nodeParams:nodeParams,modelName:modelName,i:i})
  
//   var bindParams={};
//   bindParams[i]=function(propertyValue){
//     byPath(nodeParams.node,nodeParams.path,propertyValue);
//   };

//   viewModel[modelName]=observingWrapper(viewModel[modelName],bindParams);
// }

// function bindNodeToModel(nodeParams,modelName,placeholder)
// {
//   console.log('bindNodeToModel',{nodeParams:nodeParams,modelName:modelName,placeholder:placeholder})
  
//   var bindParams={};
//   bindParams[modelName]=function(propertyValue){
//     byPath(nodeParams.node,nodeParams.path,propertyValue);
//   };

//   observingWrapper(viewModel,bindParams);
// }

// function bindElementToModel(params)
// {
//   var a,b,d,el,nodes;

//   if(Array.isArray(viewModel[params.name]))
//     for(a=0,d=viewModel[params.name].length;a<d;a++){
//       el=params.blankElement.cloneNode(true);
//       params.anchorElement.parentNode.insertBefore(el,params.anchorElement);
//       nodes=findBindingNodesOrCreate(el,params.placeholder);
//       c(nodes);
//       for(b=nodes.length;b--;)
//         // bindNodeToArrayModel(params.nodes[b],params.name,a);
//         bindNodeToArrayModel(nodes[b],params.name,a);
//     }
//   else
//     for(a=params.nodes.length;a--;)
//       bindNodeToModel(params.nodes[a],params.name,params.placeholder);
// }

function bindPropertyToElement(modelPath,bindParams)
{
  c('bindPropertyToElement',{modelPath:modelPath.slice(0),bindParams:bindParams})
  var a=modelPath.slice(0),p=modelPath.pop();
  
  for(var b=bindParams.bindingPaths.length;b--;)
    byPath(viewModel,a,observingWrapper(byPath(viewModel,modelPath),p,
      function(propertyValue){
        byPath(bindParams.anchorElement,bindParams.bindingPaths[b],propertyValue);
      }));
}

function bindProperties(modelPath,bindableElements)
{
  for(var r=bindableElements.length;r--;)
    bindPropertyToElement(modelPath,bindableElements[r]);
}

function bindElements(modelPath,bindableElements)
{ 
  c('bindElements',{modelPath:modelPath,bindableElements:bindableElements})
  
  if(typeof byPath(viewModel,modelPath)==='object'){
//     for(var e in viewModel[s][b])
//       if(bindableElements[s+':'+e]){
//   c(s+':'+e,bindableElements[s+':'+e])
//         bindProperties([s,b,e],bindableElements[s+':'+e]);
//       }
  }
  else {
    bindProperties(modelPath,bindableElements[modelPath[0]]);
  }
}

function byPath(obj,path,value)
{
  var a,b;
  // console.log('byPath',{obj:obj,path:path,value:value})

  a=path.length-1;
  for(b=0;b<a;b++)
    obj=obj[path[b]];

  if(value!==undefined)
    obj[path[a]]=value;

  return obj[path[a]];
}

function addTextNode(parentNode)
{
  parentNode.appendChild(document.createTextNode(''));
}

function findBindingPaths(node,placeholder,nodePaths,pathPrefix)
{
  var a,b,possiblePaths,path;

  nodePaths=nodePaths||[];
  pathPrefix=pathPrefix||[];
  
  [['nodeValue'],['value']]
    .forEach(function(path){
      var value=byPath(node,path);
      if(typeof value==='string'&&((placeholder&&value.indexOf(placeholder)>-1)||true)){
        nodePaths.push(pathPrefix.concat(path));
        byPath(node,path,'');
      }
      else if(value===undefined&&!placeholder){
        addTextNode(node);
        nodePaths.push(pathPrefix.concat(['childNodes',0,'nodeValue']));
      }
    });

  if((a=node.childNodes.length)&&placeholder)
    while(a--)
      findBindingPaths(node.childNodes[a],placeholder,nodePaths,pathPrefix.concat(['childNodes',a]));

  return nodePaths;
}

function findBindableElements()
{
  var a,b,c,d,e,f;

  a={};
  b=document.body.getElementsByTagName('*');

  for(c=b.length;c--;)
    for(d=b[c].attributes.length;d--;)
      if(b[c].attributes[d].name.indexOf('bb-')===0){
        f=b[c].attributes[d].name.substring(3);
        a[f]=a[f]||[];
        a[f].push({'anchorElement':b[c],'placeholder':
          b[c].attributes[d].value,'bindingPaths':findBindingPaths(b[c],
          b[c].attributes[d].value)});

        b[c].attributes.removeNamedItem(b[c].attributes.item(d).name);
      }

  return a;
}

function main()
{
  var bindableElements,a;

  bindableElements=findBindableElements();
  console.log('bindableElements',bindableElements);

  for(var s in viewModel)
    if(Array.isArray(viewModel[s]))
      for(var b=0,d=viewModel[s].length;b<d;b++)
        bindElements([s,b],bindableElements);
    else
      bindElements([s],bindableElements);

  // for(a=bindableElements.length;a--;)
  //   bindElementToModel(bindableElements[a]);

  // for(a=bindableElements.length;a--;)
  //   with(bindableElements[a]){
  //     if((blankElement.tagName==='INPUT'&&blankElement.type==='text')||(blankElement.tagName==='TEXTAREA'))
  //       blankElement.addEventListener('keyup',function(e){
  //         viewModel[name]=e.target.value;
  //       });
  //   }
}

document.addEventListener("DOMContentLoaded",main,false);

</script></head><body>

<ul>
<li bb-colors="gray"><span style="color:gray;">gray</span></li>
</ul>

<input bb-site="blarblar.com" value="blarblar.com" />
<input bb-site />
<textarea bb-site></textarea>
<button bb-site></button>

<table>
<thead>
<tr><th>Shape</th><th>Look</th></tr>
</thead>
<tbody>
<tr bb-shape:name="Line" bb-shape:look="Strait"><td>Line</td><td>Strait</td></tr>
</tbody>
</table>

<select>
<option bb-lang:code="en" bb-lang:name="English" value="en">English</option>
lang:{code:'en',name:'English'}
lang:[{code:'fr',name:'French'},{code:'nl',name:'Dutch'}]
<!-- 
<option value="fr">French</option>
<option value="nl">Dutch</option>
[['fr','French'],
 ['nl','Dutch']]
 -->
</select>

<div bb-site></div>

</body></html>
