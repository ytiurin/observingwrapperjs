<!DOCTYPE html>
<html><head><script src="observing-wrapper.js"></script><script>

function c(){console.log.apply(console,arguments)}

var
viewModel=observingWrapper({
  colors: ['red','green','blue'],
  site: 'best.com',
  shape: [{name:'Triangle',look:'Edgy'},{name:'Circle',look:'Round'},{name:'Square',look:'Blocky'}],
  lang: [{code:'en',name:'English'},{code:'fr',name:'French'},{code:'nl',name:'Dutch'}]
});

function nodeInsertAfter(referenceNode, newNode) {
  referenceNode.parentNode.insertBefore(newNode,referenceNode.nextSibling);
}

function bindModelPropertyToElement(modelPath,element,valuePath)
{
  var
  a=modelPath.slice(0,-1),b=modelPath.slice(-1)[0],
  c=observingWrapper(byPath(viewModel,a),b,function(propertyValue){
    byPath(element,valuePath,propertyValue);
  });
  
  byPath(viewModel,a,c);
}

function bindPropertyToElement(modelPath,bindParams)
{
  c('bindPropertyToElement',{modelPath:modelPath.slice(0),bindParams:bindParams})
  var ae=bindParams.anchorElement;

  if(typeof modelPath[1]==='number'&&modelPath[1]>0){
    ae=ae.cloneNode(true);
    nodeInsertAfter(bindParams.anchorElement,ae);
    bindParams.anchorElement=ae;
  }
  
  for(var b=bindParams.bindingPaths.length;b--;)
    bindModelPropertyToElement(modelPath,ae,bindParams.bindingPaths[b]);
}

function bindProperties(modelPath,bindableElements)
{
  for(var r=bindableElements.length;r--;)
    bindPropertyToElement(modelPath,bindableElements[r],r);
}

function bindElements(modelPath,bindableElements)
{ 
  c('bindElements',{modelPath:modelPath,bindableElements:bindableElements})
  var vmp=byPath(viewModel,modelPath);

  if(typeof vmp==='object'){
    var s=modelPath[0];
    for(var e in vmp)
      if(bindableElements[s+':'+e]){
  // c(s+':'+e,bindableElements[s+':'+e])
        bindProperties(modelPath.concat(e),bindableElements[s+':'+e]);
      }
  }
  else {
    bindProperties(modelPath,bindableElements[modelPath[0]]);
  }
}

function byPath(obj,path,value)
{
  var a,b;
  // c('byPath',{obj:obj,path:path,value:value})
  
  if(path.length===0)
    return obj;

  a=path.length-1;
  for(b=0;b<a;b++)
    obj=obj[path[b]];

  if(value!==undefined)
    obj[path[a]]=value;

  return obj[path[a]];
}

function addTextNode(parentNode)
{
  parentNode.appendChild(document.createTextNode(''));
}

function findBindingPaths(node,placeholder,nodePaths,pathPrefix)
{
  var a,b,possiblePaths,path;

  nodePaths=nodePaths||[];
  pathPrefix=pathPrefix||[];
  
  [['nodeValue'],['value']]
    .forEach(function(path){
      var value=byPath(node,path);
      if(typeof value==='string'&&(placeholder?value.indexOf(placeholder)>-1:true)){
        nodePaths.push(pathPrefix.concat(path));
        byPath(node,path,'');
      }
      else if(value===undefined&&!placeholder){
        addTextNode(node);
        nodePaths.push(pathPrefix.concat(['childNodes',0,'nodeValue']));
      }
    });

  if((a=node.childNodes.length)&&placeholder)
    while(a--)
      findBindingPaths(node.childNodes[a],placeholder,nodePaths,pathPrefix.concat(['childNodes',a]));

  return nodePaths;
}

function findBindableElements()
{
  var a,b,c,d,e,f;

  a={};
  b=document.body.getElementsByTagName('*');

  for(c=b.length;c--;)
    for(d=b[c].attributes.length;d--;)
      if(b[c].attributes[d].name.indexOf('bb-')===0){
        f=b[c].attributes[d].name.substring(3);
        a[f]=a[f]||[];
        a[f].push({'anchorElement':b[c],'placeholder':
          b[c].attributes[d].value,'bindingPaths':findBindingPaths(b[c],
          b[c].attributes[d].value)});

        b[c].attributes.removeNamedItem(b[c].attributes.item(d).name);
      }

  return a;
}

function main()
{
  var bindableElements,a;

  bindableElements=findBindableElements();
  c('bindableElements',bindableElements);
  c('1=======================================================================');

  for(var s in viewModel){
    c('/',s)
    if(Array.isArray(viewModel[s]))
      for(var b=0,d=viewModel[s].length;b<d;b++)
        bindElements([s,b],bindableElements);
    else
      bindElements([s],bindableElements);
  }
}

document.addEventListener("DOMContentLoaded",main,false);

</script></head><body>

<ul>
<li bb-colors="gray"><span style="color:gray;">gray</span></li>
</ul>

<input bb-site="blarblar.com" value="blarblar.com" />
<input bb-site />
<textarea bb-site></textarea>
<button bb-site></button>

<table>
<thead>
<tr><th>Shape</th><th>Look</th></tr>
</thead>
<tbody>
<tr bb-shape:name="Line" bb-shape:look="Strait"><td>Line</td><td>Strait</td></tr>
</tbody>
</table>

<select>
<option bb-lang:code="en" bb-lang:name="English" value="en">English</option>
</select>

<div bb-site></div>

</body></html>
