<!DOCTYPE html>
<html><head><script src="observing-wrapper.js"></script><script>

function c(){console.log.apply(console,arguments)}

var
viewModel=observingWrapper({
  colors: ['red','green','blue'],
  site: 'best.com',
  shape: [{name:'Triangle',look:'Edgy'},{name:'Circle',look:'Round'},{name:'Square',look:'Blocky'}],
  lang: [{code:'en',name:'English'},{code:'fr',name:'French'},{code:'nl',name:'Dutch'}]
});

function nodeInsertAfter(referenceNode, newNode) {
  referenceNode.parentNode.insertBefore(newNode,referenceNode.nextSibling);
}

function bindElementPaths2ModelPath(anchorElement,bindingPaths,modelPath)
{
  c('bindElementPaths2ModelPath',{anchorElement:anchorElement,bindingPaths:bindingPaths,modelPath:modelPath});

  for(var k=bindingPaths.length;k--;)
    bindModelPropertyToElement(modelPath,anchorElement,bindingPaths[k]);
}

function bindModelPropertyToElement(modelPath,element,valuePath)
{
  var
  a=modelPath.slice(0,-1),b=modelPath.slice(-1)[0],
  c=observingWrapper(byPath(viewModel,a),b,function(propertyValue){
    byPath(element,valuePath,propertyValue);
  });
  
  byPath(viewModel,a,c);
}

function byPath(obj,path,value)
{
  var a,b;
  // c('byPath',{obj:obj,path:path,value:value})
  
  if(path.length===0)
    return obj;

  a=path.length-1;
  for(b=0;b<a;b++)
    obj=obj[path[b]];

  if(value!==undefined)
    obj[path[a]]=value;

  return obj[path[a]];
}

function addTextNode(parentNode)
{
  parentNode.appendChild(document.createTextNode(''));
}

function findBindingPaths(node,placeholder,nodePaths,pathPrefix)
{
  var a,b,possiblePaths,path;

  nodePaths=nodePaths||[];
  pathPrefix=pathPrefix||[];
  
  [['nodeValue'],['value']]
    .forEach(function(path){
      var value=byPath(node,path);
      if(typeof value==='string'&&(placeholder?value.indexOf(placeholder)>-1:true)){
        nodePaths.push(pathPrefix.concat(path));
        // byPath(node,path,'');
      }
      else if(value===undefined&&!placeholder){
        addTextNode(node);
        nodePaths.push(pathPrefix.concat(['childNodes',0,'nodeValue']));
      }
    });

  if((a=node.childNodes.length)&&placeholder)
    while(a--)
      findBindingPaths(node.childNodes[a],placeholder,nodePaths,pathPrefix.concat(['childNodes',a]));

  return nodePaths;
}

function collectBindableElements()
{
  var a,b,c,d,e,f,g;

  a=[];
  g=[];
  b=document.body.getElementsByTagName('*');

  for(c=b.length;c--;)
    for(d=b[c].attributes.length;d--;)
      if(b[c].attributes[d].name.indexOf('bb-')===0){
        f=b[c].attributes[d].name.substring(3).split(':');
        
        if((e=g.indexOf(b[c]))===-1){
          g.push(b[c]);
          e=a.push({anchorElement:b[c],bindingData:[]})-1;
        }
        
        a[e].bindingData.push({modelPath:f,bindingPaths:findBindingPaths(b[c],
          b[c].attributes[d].value)});

        // b[c].attributes.removeNamedItem(b[c].attributes.item(d).name);
      }

  return a;
}

function main()
{
  var bindableElements,a;

  bindableElements=collectBindableElements();
  c('bindableElements',bindableElements);
  c('1=======================================================================');

  for(var l=bindableElements.length;l--;){
    var anchorElements=[bindableElements[l].anchorElement];
    var w=Math.max.apply(Math,bindableElements[l].bindingData.map(function(k){
      var u=viewModel[k.modelPath[0]];
      return (u&&Array.isArray(u)&&u.length)||0;
    }));

    if(w>1)
      for(var q=0;q<w-1;q++){c(q-1)
        var f=anchorElements[q].cloneNode(true);
        nodeInsertAfter(anchorElements[q],f);
        anchorElements.push(f);
      }
     
    for(var o=bindableElements[l].bindingData.length;o--;){
      var bindingPaths=bindableElements[l].bindingData[o].bindingPaths;
      var userModelPath=bindableElements[l].bindingData[o].modelPath;

      if(Array.isArray(viewModel[userModelPath[0]]))
        for(var j=viewModel[userModelPath[0]].length;j--;){
          var modelPath=userModelPath.slice();
          modelPath.splice(1,0,j);
          bindElementPaths2ModelPath(anchorElements[j],bindingPaths,modelPath);
        }
      
      else
        bindElementPaths2ModelPath(anchorElements[0],bindingPaths,userModelPath);
    }
  }

}

document.addEventListener("DOMContentLoaded",main,false);

</script></head><body>

<ul>
<li bb-colors="gray"><span style="color:gray;">gray</span></li>
</ul>

<input bb-site="blarblar.com" value="blarblar.com" />
<input bb-site />
<textarea bb-site></textarea>
<button bb-site></button>

<table>
<thead>
<tr><th>Shape</th><th>Look</th></tr>
</thead>
<tbody>
<tr bb-shape:name="Line" bb-shape:look="Strait"><td>Line</td><td>Strait</td></tr>
</tbody>
</table>

<select>
<option bb-lang:code="en" bb-lang:name="English" value="en">English</option>
</select>

<div bb-site></div>

</body></html>
